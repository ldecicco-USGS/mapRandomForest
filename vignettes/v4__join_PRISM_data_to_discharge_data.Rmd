---
title: "4. Join PRISM data to discharge data"
author: "Steve Westenbroek"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
    number_sections: true
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{4. Join PRISM data to discharge data}
  \usepackage[utf8]{inputenc}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

In this step the *.csv files generated in previous steps are left-joined to the monthly discharge values dataframe. Successive joins add precip, tmin, tmax, and tmean-related values and lagged values to the dataframe. Also, the centroid coordinate values calculated in an earlier step are joined to this dataframe.

# Read in monthly discharge file and create a suitable field for use in joining additional data fields.

```{r}
# the 'magrittr' package provides the 'pipe' operator ('%>%') used throughout the vignettes
library(magrittr)

monthly_discharge_vignette <- readr::read_csv("monthly_discharge.csv")
monthly_discharge_vignette$yyyymmdd <- lubridate::ymd(paste(monthly_discharge_vignette$date,"15",sep="-"))

# clip off the more recent data to make comparisons to Brian's original data
monthly_discharge_vignette           <- monthly_discharge_vignette %>%
                                          dplyr::filter(yyyymmdd < lubridate::ymd("2016-10-31"))
monthly_discharge_vignette$joinfield <- with(monthly_discharge_vignette, paste(site_no,date,sep="_"))

```

# Read in precipitation values and clean up precipitation dataframe.

```{r}

mean_ppt_values <- readr::read_csv("mean_ppt_values_w_lag.csv")
mean_ppt_values$yyyymmdd <- lubridate::ymd(paste(mean_ppt_values$date,"15",sep="-"))

# clip off the more recent data to make comparisons to Brian's original data
mean_ppt_values           <- mean_ppt_values %>%
                               dplyr::filter(yyyymmdd < lubridate::ymd("2016-10-31")) 
mean_ppt_values$joinfield <- with(mean_ppt_values, paste(site_no,date,sep="_"))

mean_ppt_values <- dplyr::select(mean_ppt_values,"joinfield","precip","precip_lag_1m","precip_lag_2m","precip_sum_6m")

```

# Join precip values to random forest input dataframe.

```{r}


random_forest_training_df <- dplyr::left_join(x=monthly_discharge_vignette,
                                              y=mean_ppt_values,
                                              by=("joinfield"="joinfield"))

```

# Read in tmin values and clean up tmin dataframe.

```{r}

mean_tmin_values <- readr::read_csv("mean_tmin_values_w_lag.csv")
mean_tmin_values$yyyymmdd <- lubridate::ymd(paste(mean_tmin_values$date,"15",sep="-"))

# clip off the more recent data to make comparisons to Brian's original data
mean_tmin_values           <- mean_tmin_values %>%
                               dplyr::filter(yyyymmdd < lubridate::ymd("2016-10-31")) 
mean_tmin_values$joinfield <- with(mean_tmin_values, paste(site_no,date,sep="_"))

# eliminate all other fields except those we wish to have in the final random forest input
mean_tmin_values <- dplyr::select(mean_tmin_values,"joinfield","tmin","tmin_lag_1m","tmin_lag_2m")

```

# Join tmin values to random forest input dataframe.

```{r}


random_forest_training_df <- dplyr::left_join(x=random_forest_training_df,
                                              y=mean_tmin_values,
                                              by=("joinfield"="joinfield"))

```

# Read in tmax values and clean up tmax dataframe.

```{r}

mean_tmax_values <- readr::read_csv("mean_tmax_values_w_lag.csv")
mean_tmax_values$yyyymmdd <- lubridate::ymd(paste(mean_tmax_values$date,"15",sep="-"))

# clip off the more recent data to make comparisons to Brian's original data
mean_tmax_values           <- mean_tmax_values %>%
                               dplyr::filter(yyyymmdd < lubridate::ymd("2016-10-31")) 
mean_tmax_values$joinfield <- with(mean_tmax_values, paste(site_no,date,sep="_"))

# eliminate all other fields except those we wish to have in the final random forest input
mean_tmax_values <- dplyr::select(mean_tmax_values,"joinfield","tmax","tmax_lag_1m","tmax_lag_2m")

```

# Join tmax values to random forest input dataframe.

```{r}


random_forest_training_df <- dplyr::left_join(x=random_forest_training_df,
                                              y=mean_tmax_values,
                                              by=("joinfield"="joinfield"))
```

# Read in tmean values and clean up tmean dataframe.

```{r}

mean_tmean_values <- readr::read_csv("mean_tmean_values_w_lag.csv")
mean_tmean_values$yyyymmdd <- lubridate::ymd(paste(mean_tmean_values$date,"15",sep="-"))

# clip off the more recent data to make comparisons to Brian's original data
mean_tmean_values           <- mean_tmean_values %>%
                               dplyr::filter(yyyymmdd < lubridate::ymd("2016-10-31")) 
mean_tmean_values$joinfield <- with(mean_tmean_values, paste(site_no,date,sep="_"))

# eliminate all other fields except those we wish to have in the final random forest input
mean_tmean_values <- dplyr::select(mean_tmean_values,"joinfield","tmean","tmean_lag_1m","tmean_lag_2m")

```

# Join tmean values to random forest input dataframe.

```{r}


random_forest_training_df <- dplyr::left_join(x=random_forest_training_df,
                                              y=mean_tmean_values,
                                              by=("joinfield"="joinfield"))
```


# Join latitude values to random forest input dataframe.

```{r join_latitude_values_to_streamflow}

centroid_coordinates_df <- readr::read_csv("centroid_coordinates.csv")

random_forest_training_df <- dplyr::left_join(x=random_forest_training_df,
                                              y=centroid_coordinates_df,
                                              by=("site_no"="site_no"))


```

# Write out random forest model input file to a *.csv file for use in later vignettes.

```{r write_output_to_csv}

# filter out some rows with NA values
random_forest_training_df <- random_forest_training_df %>% 
                               dplyr::filter( !is.na(tmean_lag_1m)) %>% 
                               dplyr::filter( !is.na(tmean)) %>% 
                               dplyr::filter( !is.na(tmax_lag_2m)) %>% 
                               dplyr::filter( !is.na(precip_lag_2m)) %>% 
                               dplyr::filter(!is.na(precip_sum_6m))

readr::write_csv(random_forest_training_df,"random_forest_model_stream_and_temp_inputs.csv")

```
